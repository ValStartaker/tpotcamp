<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>tpot.camp</title>

    <link rel="stylesheet" href="index.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script src="events.js"></script>
  </head>

  <body>
    <nav class="header">
      <h1>tpot.camp</h1>
      <p>The community event listing website</p>
    </nav>

    <main class="container">
      <div class="map-section">
        <div class="legend-container">
          <div class="legend">
            <div class="legend-item">
              <h3>Event Types</h3>
            </div>
            <div class="legend-item">
              <div class="legend-icon camp"></div>
              <span>Camp</span>
            </div>
            <div class="legend-item">
              <div class="legend-icon meetup"></div>
              <span>Meetup</span>
            </div>
            <div class="legend-item">
              <div class="legend-icon grouphouse"></div>
              <span>Group House</span>
            </div>
            <div class="legend-item">
              <div class="legend-icon fractalido"></div>
              <span>Fractalido</span>
            </div>
            <div class="legend-item">
              <div class="legend-icon misc"></div>
              <span>Misc</span>
            </div>
            <div class="legend-item">
              <a href="institutions.html" style="color: #3498db; text-decoration: none; font-size: 0.9em; margin-left: 10px;">View Institutions ‚Üí</a>
            </div>
            
          </div>
        </div>
        <div id="map"></div>
      </div>

      <div class="events-section">
        <h2>Upcoming Events</h2>
        <div id="eventsList"></div>
      </div>

      <div class="form-section">
        <h2>Submit event</h2>
        <p style="text-align: center; margin-bottom: 30px; color: #7f8c8d">
          Have an event to share? Fill out the form below and we'll review it
          for addition to the map.
        </p>

        <!-- Replace YOUR_FORM_ID with your actual Formspree form ID -->
        <form
          action="https://formspree.io/f/xgvzqwlg"
          method="POST"
          id="eventForm"
        >
          <div class="form-grid">
            <div class="form-group">
              <label for="eventName">Event Name *</label>
              <input type="text" id="eventName" name="eventName" required />
            </div>

            <div class="form-group">
              <label for="eventType">Event Type *</label>
              <select id="eventType" name="eventType" required>
                <option value="">Select type...</option>
                <option value="camp">Camp</option>
                <option value="meetup">Meetup</option>
                <option value="grouphouse">Group House</option>
                <option value="fractalido">Fractalido</option>
                <option value="Misc">Misc</option>
              </select>
            </div>

            <div class="form-group">
              <label for="eventStartDate">Start Date *</label>
              <input type="date" id="eventStartDate" name="eventStartDate" required />
            </div>

            <div class="form-group">
              <label for="eventEndDate">End Date (optional)</label>
              <input type="date" id="eventEndDate" name="eventEndDate" />
            </div>

            <div class="form-group">
              <label for="eventTime">Event Time</label>
              <input type="time" id="eventTime" name="eventTime" />
            </div>

            <div class="form-group full-width">
              <label for="eventAddress">Event Address *</label>
              <input
                type="text"
                id="eventAddress"
                name="eventAddress"
                placeholder="123 Main St, City, State"
                required
              />
            </div>

            <div class="form-group">
              <label for="organizerName">Your Name *</label>
              <input
                type="text"
                id="organizerName"
                name="organizerName"
                required
              />
            </div>

            <div class="form-group">
              <label for="organizerEmail">Your Email *</label>
              <input
                type="email"
                id="organizerEmail"
                name="organizerEmail"
                required
              />
            </div>

            <div class="form-group full-width">
              <label for="eventDescription">Event Description *</label>
              <textarea
                id="eventDescription"
                name="eventDescription"
                placeholder="Tell us about your event..."
                required
              ></textarea>
            </div>

            <div class="form-group full-width">
              <label for="eventWebsite"
                >Event Website/Social Media (optional)</label
              >
              <input
                type="url"
                id="eventWebsite"
                name="eventWebsite"
                placeholder="https://..."
              />
            </div>
          </div>

          <button type="submit" class="submit-btn">
            Submit Event for Review
          </button>
        </form>
      </div>
    </main>

    <footer class="footer">
      <p>
        &copy; 2025, maintained by @AletheiaAsriel, help and vibes from @actualwebutante, @seventhmeal and
        @AbsurdistFool
      </p>
    </footer>

    <script>
      // create map
      const map = L.map("map").setView([40.7128, -74.006], 11);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "¬© OpenStreetMap contributors",
      }).addTo(map);

      const eventColors = {
        camp: "#e74c3c",
        meetup: "#f39c12",
        grouphouse: "#9b59b6",
        fractalido: "#27ae60",
        misc: "#3498db",
      };

      let events = [];

      // load events from JS file
      function loadEvents() {
        events = eventsData;
        renderEventsList();
        renderMapMarkers();
      }

      // render map markers
      function renderMapMarkers() {
        events.forEach((event) => {
          const marker = L.circleMarker([event.lat, event.lng], {
            radius: 12,
            fillColor: eventColors[event.type],
            color: "#fff",
            weight: 2,
            opacity: 1,
            fillOpacity: 0.8,
          }).addTo(map);

          const popupContent = `
                <div class="popup-content">
                    <h3>${event.name}</h3>
                    <div class="date">${
                      event.endDate && event.endDate !== event.startDate
                        ? `${new Date(event.startDate).toLocaleDateString()} - ${new Date(event.endDate).toLocaleDateString()}`
                        : new Date(event.startDate).toLocaleDateString()
                    }</div>
                    <div class="time">${
                      event.time
                        ? new Date(
                            `2000-01-01T${event.time}`
                          ).toLocaleTimeString([], {
                            hour: "2-digit",
                            minute: "2-digit",
                          })
                        : ""
                    }</div>
                    <div class="description">${event.description}</div>
                    <div style="margin-top: 10px; font-size: 0.9em; color: #7f8c8d;">
                        üìç ${event.address}
                    </div>
                    ${event.website ? `<div style="margin-top: 8px;">
                        üîó <a href="${event.website}" target="_blank" rel="noopener noreferrer" style="color: #3498db; text-decoration: none;">${event.website}</a>
                    </div>` : ''}
                </div>
            `;

          marker.bindPopup(popupContent);
        });
      }

      // create event list
      function renderEventsList() {
        const eventsListContainer = document.getElementById("eventsList");

        // sort events by date and time
        const sortedEvents = events.sort((a, b) => {
          const dateA = new Date(`${a.startDate}T${a.time || "00:00"}`);
          const dateB = new Date(`${b.startDate}T${b.time || "00:00"}`);
          return dateA - dateB;
        });

        // filter future events
        const now = new Date();
        const upcomingEvents = sortedEvents.filter((event) => {
          const eventEndDate = event.endDate ? new Date(`${event.endDate}T23:59`) : new Date(`${event.startDate}T${event.time || "23:59"}`);
          return eventEndDate >= now;
        });

        if (upcomingEvents.length === 0) {
          eventsListContainer.innerHTML =
            '<div class="no-events">No upcoming events scheduled.</div>';
          return;
        }

        const eventsHTML = upcomingEvents
          .map((event) => {
            const startDate = new Date(event.startDate);
            const formattedDate = event.endDate && event.endDate !== event.startDate
              ? `${startDate.toLocaleDateString("en-US", {
                  weekday: "long",
                  year: "numeric",
                  month: "long",
                  day: "numeric",
                })} - ${new Date(event.endDate).toLocaleDateString("en-US", {
                  weekday: "long",
                  year: "numeric",
                  month: "long",
                  day: "numeric",
                })}`
              : startDate.toLocaleDateString("en-US", {
                  weekday: "long",
                  year: "numeric",
                  month: "long",
                  day: "numeric",
                });

            const formattedTime = event.time
              ? new Date(`2000-01-01T${event.time}`).toLocaleTimeString([], {
                  hour: "2-digit",
                  minute: "2-digit",
                })
              : "";

            return `
            <div class="event-item ${event.type}">
              <div class="event-header">
                <h3 class="event-name">${event.name}</h3>
                <span class="event-type ${event.type}">${event.type}</span>
              </div>
              <div class="event-datetime">
                <span>üìÖ ${formattedDate}</span>
                ${formattedTime ? `<span>üïê ${formattedTime}</span>` : ""}
              </div>
              <div class="event-description">${event.description}</div>
              <div class="event-address">
                <span>üìç</span>
                <span>${event.address}</span>
              </div>
              ${event.website ? `<div class="event-link">
                <span>üîó</span>
                <a href="${event.website}" target="_blank" rel="noopener noreferrer">${event.website}</a>
              </div>` : ''}
            </div>
          `;
          })
          .join("");

        eventsListContainer.innerHTML = eventsHTML;
      }

      // load events on page load
      loadEvents();


      const form = document.getElementById("eventForm");

      form.addEventListener("submit", function (e) {
        e.preventDefault();

        // form validation
        const requiredFields = form.querySelectorAll("[required]");
        let isValid = true;

        requiredFields.forEach((field) => {
          if (!field.value.trim()) {
            isValid = false;
            field.style.borderColor = "#e74c3c";
          } else {
            field.style.borderColor = "#e0e0e0";
          }
        });

        if (!isValid) {
          alert("Please fill in all required fields.");
          return;
        }

        const formData = new FormData(form);

        fetch(form.action, {
          method: "POST",
          body: formData,
          headers: {
            Accept: "application/json",
          },
        })
          .then((response) => {
            if (response.ok) {
              alert(
                "Thank you! Your event submission has been received and will be reviewed shortly."
              );
              form.reset();
            } else {
              throw new Error("Form submission failed");
            }
          })
          .catch((error) => {
            console.error("Error:", error);
            alert(
              "There was an error submitting your event. Please try again or contact us directly."
            );
          });
      });

      document.getElementById("eventDate").min = new Date()
        .toISOString()
        .split("T")[0];
    </script>
  </body>
</html>
